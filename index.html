<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <title>Packet Capture</title>

  <link rel="stylesheet" href="index.css" />
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="topojson.v1.min.js"></script>
  <script src="http://underscorejs.org/underscore-min.js"></script>

</head>
<body>
  <div id="map_container"></div>
  <div id="ip_list">
	<table>
		<thead>
			<th>Destination</th>
			<th>pps</th>
			<th>mbps</th>
		</thead>
		<tr class="1"><td class="dest"></td><td class="ppm"></td><td class="mbps"></td></tr>
		<tr class="2"><td class="dest"></td><td class="ppm"></td><td class="mbps"></td></tr>
		<tr class="3"><td class="dest"></td><td class="ppm"></td><td class="mbps"></td></tr>
		<tr class="4"><td class="dest"></td><td class="ppm"></td><td class="mbps"></td></tr>
		<tr class="5"><td class="dest"></td><td class="ppm"></td><td class="mbps"></td></tr>
		<tr class="6"><td class="dest"></td><td class="ppm"></td><td class="mbps"></td></tr>
		<tr class="7"><td class="dest"></td><td class="ppm"></td><td class="mbps"></td></tr>
		<tr class="8"><td class="dest"></td><td class="ppm"></td><td class="mbps"></td></tr>
		<tr class="9"><td class="dest"></td><td class="ppm"></td><td class="mbps"></td></tr>
		<tr class="10"><td class="dest"></td><td class="ppm"></td><td class="mbps"></td></tr>
		<tr></tr>
	</table>
  </div>
  <div id="intensity_feed"></div>

  <script src="worldmap.js"></script>
  <script>
	var my_ip = [];
	var stats = new Object(); // Holds the stats per IP
	var countries = {};
	var clients = {};

	window.onload = function() {
		d3.json("data/world-topo-min.json", function(error, world) {
			list = topojson.feature(world, world.objects.countries).features;
			list.forEach(function(country){
				country.properties.color = "#CCCCCC";
				countries[country.properties.name] = country;
			});
			
			draw(_.values(countries));

			window.addEventListener('packet_received', function (event) {
				var packet = event.detail;

				updateStats(packet);
				// sendPacket(packet.sloc, packet.dloc);
				throttle();
			}, false);

			window.addEventListener('ip_received', function (event) {
				var packet = event.detail;

				my_ip = packet;
				console.log("My ip is " + my_ip);
			}, false);
		});

		var ws = new WebSocket('ws://localhost:8080');

		ws.onmessage = function(event) {
		  var msg = JSON.parse(event.data);

		  switch(msg.type) {
		    case "packet" : window.dispatchEvent(new CustomEvent('packet_received', {"detail": msg.packet})); break;
		    case "ip"     : window.dispatchEvent(new CustomEvent('ip_received', {"detail": msg.ip})); break;
		  }
		}
	}

	function updateStats(packet) {
	  [packet.sloc, packet.dloc].forEach(function(country) {
	    if(countries[country]['stats'] !== undefined) return;

			countries[country]['stats'] = {
			  'packets_total': {'in': 0,'out': 0},
			  'packets_ps': {'in': 0,'out': 0},
			  'size_total': {'in': 0,'out': 0},
			  'size_ps': {'in': 0,'out': 0}
			};
	    });
	  [packet.saddr, packet.daddr].forEach(function(address) { 
		if(clients[address]['stats'] !== undefined) return;

			clients[address]['stats'] = {
			  'packets_total': {'in': 0,'out': 0},
			  'packets_ps': {'in': 0,'out': 0},
			  'size_total': {'in': 0,'out': 0},
			  'size_ps': {'in': 0,'out': 0}
			};
	    });

	    var country_interval = setInterval((function(){
	      var country_prev_total_packets = {
	        'in': countries[country]['stats']['packets_total']['in'], 
	        'out': countries[country]['stats']['packets_total']['out'] 
	      }

	      var country_prev_total_size = {
	        'in': countries[country]['stats']['size_total']['in'],
	        'out': countries[country]['stats']['size_total']['out']
	      }

	      return function() {
	        countries[country]['stats']['packets_ps'] = {
	          'in': countries[country]['stats']['packets_total']['in'] - country_prev_total_packets.in,
	          'out': countries[country]['stats']['packets_total']['out'] - country_prev_total_packets.out
	        }

	        countries[country]['stats']['size_ps'] = {
	          'in': countries[country]['stats']['size_total']['in'] - country_prev_total_size.in,
	          'out': countries[country]['stats']['size_total']['out'] - country_prev_total_size.out
	        }

	        prev_total_packets = {
	          'in': countries[country]['stats']['packets_total']['in'], 
	          'out': countries[country]['stats']['packets_total']['out'] 
	        }

	        prev_total_size = {
	          'in': countries[country]['stats']['size_total']['in'],
	          'out': countries[country]['stats']['size_total']['out']
	        }
	      }
	    })(), 1000);
	  });
	  var client_interval = setInterval((function(){
	      var client_prev_total_packets = {
	        'in': clients[address]['stats']['packets_total']['in'], 
	        'out': clients[address]['stats']['packets_total']['out'] 
	      }

	      var client_prev_total_size = {
	        'in': clients[address]['stats']['size_total']['in'],
	        'out': clients[address]['stats']['size_total']['out']
	      }

	      return function() {
	        clients[address]['stats']['packets_ps'] = {
	          'in': clients[address]['stats']['packets_total']['in'] - client_prev_total_packets.in,
	          'out': clients[address]['stats']['packets_total']['out'] - client_prev_total_packets.out
	        }

	        clients[address]['stats']['size_ps'] = {
	          'in': clients[address]['stats']['size_total']['in'] - client_prev_total_size.in,
	          'out': clients[address]['stats']['size_total']['out'] - client_prev_total_size.out
	        }

	        prev_total_packets = {
	          'in': clients[address]['stats']['packets_total']['in'], 
	          'out': clients[address]['stats']['packets_total']['out'] 
	        }

	        prev_total_size = {
	          'in': clients[address]['stats']['size_total']['in'],
	          'out': clients[address]['stats']['size_total']['out']
	        }
	      }
	    })(), 1000);
	  });

	  countries[packet.sloc]['stats']['packets_total']['out'] += 1;
	  countries[packet.sloc]['stats']['size_total']['out'] += packet.size;

	  countries[packet.dloc]['stats']['packets_total']['in'] += 1;
	  countries[packet.dloc]['stats']['size_total']['in'] += packet.size;
	  
	  clients[packet.daddr]['stats']['packets_total']['out'] += 1;
	  clients[packet.daddr]['stats']['size_total']['out'] += packet.size;

	  clients[packet.saddr]['stats']['packets_total']['in'] += 1;
	  clients[packet.saddr]['stats']['size_total']['in'] += packet.size;
	  //sort by highest traffic
	  
	  //take top 10
	  
	  //updateList(top10);
	}

	function updateList(packet_array) {
		$("#ip_list.1.dest").html(packet_array[0].dest);
		$("#ip_list.1.ppm").html(packet_array[0].ppm);
		$("#ip_list.1.mbps").html(packet_array[0].mbps);
		$("#ip_list.2.dest").html(packet_array[0].dest);
		$("#ip_list.2.ppm").html(packet_array[0].ppm);
		$("#ip_list.2.mbps").html(packet_array[0].mbps);
		//etc
	}
	}

	function sendPacket(from, to) {
		// console.log("Send packe/t", from, to);
	}
  </script>
</body>
</html>
