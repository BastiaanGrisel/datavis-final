<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <title>Packet Capture</title>

  <link rel="stylesheet" href="index.css" />
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="topojson.v1.min.js"></script>

</head>
<body>
  <div id="map_container"></div>
  <div id="ip_list"></div>
  <div id="intensity_feed"></div>

  <script src="worldmap.js"></script>
  <script>
	var my_ips = [];
	var stats = new Object(); // Holds the stats per IP

	window.onload = function() {
		var ws = new WebSocket('ws://localhost:8080');

		ws.onmessage = function(event) {
		  var msg = JSON.parse(event.data);

		  switch(msg.type) {
		    case "packet" : window.dispatchEvent(new CustomEvent('packet_received', {"detail": msg.packet})); break;
		    case "ip"     : window.dispatchEvent(new CustomEvent('ip_received', {"detail": msg.ip})); break;
		  }
		}
	}

	window.addEventListener('packet_received', function (event) {
		var packet = event.detail;

		updateStats(packet);
	}, false);

	window.addEventListener('ip_received', function (event) {
		var packet = event.detail;

		my_ips = packet;
		console.log("My ips are " + my_ips);
	}, false);

	function updateStats(packet) {
	  [packet.saddr, packet.daddr].forEach(function(ip) {
	    if(stats[ip] !== undefined) return;

	    stats[ip] = {
	      'packets_total': {'in': 0,'out': 0},
	      'packets_ps': {'in': 0,'out': 0},
	      'size_total': {'in': 0,'out': 0},
	      'size_ps': {'in': 0,'out': 0}
	    };

	    setInterval((function(){
	      var prev_total_packets = {
	        'in': stats[ip]['packets_total']['in'], 
	        'out': stats[ip]['packets_total']['out'] 
	      }

	      var prev_total_size = {
	        'in': stats[ip]['size_total']['in'],
	        'out': stats[ip]['size_total']['out']
	      }

	      return function() {
	        stats[ip]['packets_ps'] = {
	          'in': stats[ip]['packets_total']['in'] - prev_total_packets.in,
	          'out': stats[ip]['packets_total']['out'] - prev_total_packets.out
	        }

	        stats[ip]['size_ps'] = {
	          'in': stats[ip]['size_total']['in'] - prev_total_size.in,
	          'out': stats[ip]['size_total']['out'] - prev_total_size.out
	        }

	        prev_total_packets = {
	          'in': stats[ip]['packets_total']['in'], 
	          'out': stats[ip]['packets_total']['out'] 
	        }

	        prev_total_size = {
	          'in': stats[ip]['size_total']['in'],
	          'out': stats[ip]['size_total']['out']
	        }
	      }
	    })(), 1000);
	  });

	  stats[packet.saddr]['packets_total']['out'] += 1;
	  stats[packet.saddr]['size_total']['out'] += packet.size;

	  stats[packet.daddr]['packets_total']['in'] += 1;
	  stats[packet.daddr]['size_total']['in'] += packet.size;
	}
  </script>
</body>
</html>
