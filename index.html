<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <title>Packet Capture</title>

  <script src="http://d3js.org/d3.v3.min.js"></script>
</head>
<body>
  <script>
  var stats = new Object(); // Holds the stats per IP
  var my_ips = [];

  window.onload = function() {
    var ws = new WebSocket('ws://localhost:8080');

    ws.onmessage = function(event) {
      var msg = JSON.parse(event.data);

      switch(msg.type) {
        case "packet" : window.dispatchEvent(new CustomEvent('packet_received', {"detail": msg.packet})); break;
        case "ip"     : window.dispatchEvent(new CustomEvent('ip_received', {"detail": msg.ip})); break;
      }
    }
  }

  window.addEventListener('packet_received', function (event) {
    var packet = event.detail;

    updateStats(packet);
  }, false);

  window.addEventListener('ip_received', function (event) {
    var packet = event.detail;

    my_ips = packet;
    console.log("My ips are " + my_ips);
  }, false);

  function updateStats(packet) {
    [packet.saddr, packet.daddr].forEach(function(ip) {
      if(stats[ip] !== undefined) return;

      stats[ip] = new Object();
      stats[ip]['packets_total'] = new Object();
      stats[ip]['size'] = new Object();

      stats[ip]['packets_total']['in'] = 0;
      stats[ip]['packets_total']['out'] = 0;
      stats[ip]['size']['in'] = 0;
      stats[ip]['size']['out'] = 0;
    });

    if(stats[packet.saddr]['packets_ps'] === undefined) {
      stats[packet.saddr]['packets_ps'] = new Object();
      stats[packet.saddr]['packets_ps']['in'] = 0;
      stats[packet.saddr]['packets_ps']['out'] = 0;

      setInterval((function(){
        var prev = stats[packet.saddr]['packets_total']['out'];

        return function() {
          stats[packet.saddr]['packets_ps']['out'] = stats[packet.saddr]['packets_total']['out'] - prev;
          prev = stats[packet.saddr]['packets_total']['out'];
        }
      })(), 1000);
    }
    
    if(stats[packet.daddr]['packets_ps'] === undefined) {
      stats[packet.daddr]['packets_ps'] = new Object();
      stats[packet.daddr]['packets_ps']['in'] = 0;
      stats[packet.daddr]['packets_ps']['out'] = 0;

      setInterval((function(){
        var prev = stats[packet.daddr]['packets_total']['in'];

        return function() {
          stats[packet.daddr]['packets_ps']['in'] = stats[packet.daddr]['packets_total']['in'] - prev;
          prev = stats[packet.daddr]['packets_total']['in'];
        }
      })(), 1000);
    }

    stats[packet.saddr]['packets_total']['out'] += 1;
    stats[packet.saddr]['size']['out'] += packet.size;

    stats[packet.daddr]['packets_total']['in'] += 1;
    stats[packet.daddr]['size']['in'] += packet.size;
  }
  </script>
</body>
</html>
