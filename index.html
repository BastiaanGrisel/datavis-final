<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <title>Packet Capture</title>

  <link rel="stylesheet" href="index.css" />
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="topojson.v1.min.js"></script>
  <script src="http://underscorejs.org/underscore-min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
</head>
<body>
  <div id="map_container"></div>
  <div id="ip_list" style="display:none">
	<table>
		<thead>
			<th>Destination</th>
			<th>pps</th>
			<th>MBps</th>
		</thead>
		<tr><td id="ip_list_1_dest"></td><td id="ip_list_1_ppm"></td><td id="ip_list_1_mbps"></td></tr>
		<tr><td id="ip_list_2_dest"></td><td id="ip_list_2_ppm"></td><td id="ip_list_2_mbps"></td></tr>
		<tr><td id="ip_list_3_dest"></td><td id="ip_list_3_ppm"></td><td id="ip_list_3_mbps"></td></tr>
		<tr><td id="ip_list_4_dest"></td><td id="ip_list_4_ppm"></td><td id="ip_list_4_mbps"></td></tr>
		<tr><td id="ip_list_5_dest"></td><td id="ip_list_5_ppm"></td><td id="ip_list_5_mbps"></td></tr>
		<tr><td id="ip_list_6_dest"></td><td id="ip_list_6_ppm"></td><td id="ip_list_6_mbps"></td></tr>
		<tr><td id="ip_list_7_dest"></td><td id="ip_list_7_ppm"></td><td id="ip_list_7_mbps"></td></tr>
		<tr><td id="ip_list_8_dest"></td><td id="ip_list_8_ppm"></td><td id="ip_list_8_mbps"></td></tr>
		<tr><td id="ip_list_9_dest"></td><td id="ip_list_9_ppm"></td><td id="ip_list_9_mbps"></td></tr>
		<tr><td id="ip_list_10_dest"></td><td id="ip_list_10_ppm"></td><td id="ip_list_10_mbps"></td></tr>
	</table>
  </div>
  <div id="legend">
  	<div id="title">Cumulative size of information in megabytes going in and out of a country</div>
  	<div id="legend_bar">
	  	<div id="legend_min" style="float: left"><span>0</span> MB</div>
	  	<div id="legend_max" style="float: right"><span>0</span> MB</div>
	  	<div style="clear:both; padding: 0; margin: 0"></div> <!-- Stupid clearfixes, it's 2015 for god's sake -->
  	</div>
  </div>
  <script src="worldmap.js"></script>
  <script>
	var my_ip = [];
	var stats = new Object(); // Holds the stats per IP
	var countries = {};
	var clients = {};
	var country_interval;
	var client_interval;

	window.onload = function() {
		d3.json("data/world-topo-min.json", function(error, world) {
			list = topojson.feature(world, world.objects.countries).features;
			list.forEach(function(country){
				country.properties.color = "#CCCCCC";
				countries[country.properties.name] = country;
			});

			g.append("circle");
			
			draw(_.values(countries));

			window.addEventListener('packet_received', function (event) {
				var packet = event.detail;

				updateStats(packet);
				throttle();
			}, false);

			window.addEventListener('ip_received', function (event) {
				var packet = event.detail;

				my_ip = packet;
				console.log("My ip is " + my_ip);
			}, false);
		});

		var ws = new WebSocket('ws://localhost:8080');

		ws.onmessage = function(event) {
		  var msg = JSON.parse(event.data);

		  switch(msg.type) {
		    case "packet" : window.dispatchEvent(new CustomEvent('packet_received', {"detail": msg.packet})); break;
		    case "ip"     : window.dispatchEvent(new CustomEvent('ip_received', {"detail": msg.ip})); break;
		  }
		}
	}
	
	function updateStats(packet) {
	  [packet.sloc, packet.dloc].forEach(function(country) {
		country = findCountry(country);
	    if(countries[country]['stats'] !== undefined) return;

			countries[country]['stats'] = {
			  'packets_total': {'in': 0,'out': 0},
			  'packets_ps': {'in': 0,'out': 0},
			  'size_total': {'in': 0,'out': 0},
			  'size_ps': {'in': 0,'out': 0}
			};

			setInterval((function(){
			  var country_prev_total_packets = {
				'in': countries[country]['stats']['packets_total']['in'], 
				'out': countries[country]['stats']['packets_total']['out'] 
			  }

			  var country_prev_total_size = {
				'in': countries[country]['stats']['size_total']['in'],
				'out': countries[country]['stats']['size_total']['out']
			  }

			  return function() {
				countries[country]['stats']['packets_ps'] = {
				  'in': countries[country]['stats']['packets_total']['in'] - country_prev_total_packets.in,
				  'out': countries[country]['stats']['packets_total']['out'] - country_prev_total_packets.out
				}

				countries[country]['stats']['size_ps'] = {
				  'in': countries[country]['stats']['size_total']['in'] - country_prev_total_size.in,
				  'out': countries[country]['stats']['size_total']['out'] - country_prev_total_size.out
				}

				country_prev_total_packets = {
				  'in': countries[country]['stats']['packets_total']['in'], 
				  'out': countries[country]['stats']['packets_total']['out'] 
				}

				country_prev_total_size = {
				  'in': countries[country]['stats']['size_total']['in'],
				  'out': countries[country]['stats']['size_total']['out']
				}
			  }
			})(), 1000);
		  });
	  [packet.saddr, packet.daddr].forEach(function(address) { 
	  if(clients[address] !== undefined) return;

		clients[address] = {stats: {
		  'packets_total': {'in': 0,'out': 0,'sum': 0},
		  'packets_ps': {'in': 0,'out': 0,'sum': 0},
		  'size_total': {'in': 0,'out': 0,'sum': 0},
		  'size_ps': {'in': 0,'out': 0,'sum': 0}}
		};
		setInterval((function(){
			  var client_prev_total_packets = {
				'in': clients[address]['stats']['packets_total']['in'], 
				'out': clients[address]['stats']['packets_total']['out'],
				'sum': clients[address]['stats']['packets_total']['sum'] 
			  }

			  var client_prev_total_size = {
				'in': clients[address]['stats']['size_total']['in'],
				'out': clients[address]['stats']['size_total']['out'],
				'sum': clients[address]['stats']['packets_total']['sum'] 
			  }

			  return function() {
				clients[address]['stats']['packets_ps'] = {
				  'in': clients[address]['stats']['packets_total']['in'] - client_prev_total_packets.in,
				  'out': clients[address]['stats']['packets_total']['out'] - client_prev_total_packets.out,
				  'sum': clients[address]['stats']['packets_total']['in'] + 
				  clients[address]['stats']['packets_total']['out'] - client_prev_total_packets.sum
				}

				clients[address]['stats']['size_ps'] = {
				  'in': clients[address]['stats']['size_total']['in'] - client_prev_total_size.in,
				  'out': clients[address]['stats']['size_total']['out'] - client_prev_total_size.out,
				  'sum': clients[address]['stats']['size_total']['in'] + 
				  clients[address]['stats']['size_total']['out'] - client_prev_total_size.sum
				}

				client_prev_total_packets = {
				  'in': clients[address]['stats']['packets_total']['in'], 
				  'out': clients[address]['stats']['packets_total']['out'],
				  'sum': clients[address]['stats']['packets_total']['sum']
				}

				client_prev_total_size = {
				  'in': clients[address]['stats']['size_total']['in'],
				  'out': clients[address]['stats']['size_total']['out'],
				  'sum': clients[address]['stats']['size_total']['sum']
				}
			  }
			})(), 1000);
		  });

	  packet.sloc = findCountry(packet.sloc);
	  packet.dloc = findCountry(packet.dloc);
	  countries[packet.sloc]['stats']['packets_total']['out'] += 1;
	  countries[packet.sloc]['stats']['size_total']['out'] += packet.size;

	  countries[packet.dloc]['stats']['packets_total']['in'] += 1;
	  countries[packet.dloc]['stats']['size_total']['in'] += packet.size;
	  
	  clients[packet.daddr]['stats']['packets_total']['out'] += 1;
	  clients[packet.daddr]['stats']['packets_total']['sum'] += 1;
	  clients[packet.daddr]['stats']['size_total']['out'] += packet.size;
	  clients[packet.daddr]['stats']['size_total']['sum'] += packet.size;

	  clients[packet.saddr]['stats']['packets_total']['in'] += 1;
	  clients[packet.saddr]['stats']['packets_total']['sum'] += 1;
	  clients[packet.saddr]['stats']['size_total']['in'] += packet.size;
	  clients[packet.saddr]['stats']['size_total']['sum'] += packet.size;
	  
	  updateList();
	}
	
	function findCountry(country){
		for(var c in countries) {
			if(c.indexOf(country)!= -1) {
				//console.log("Detected "+country+" as "+c);
				country = c;
				break;
			}
		}
		return country;
	}

	function updateList() {
		//get order list
		var order = [];
		for(var client in clients){
			order.push(client);
		};
		//sort order
		order.sort(function(a,b){
			if(clients[a]['stats']['packets_ps']['sum'] < clients[b]['stats']['packets_ps']['sum'])
				return 1;
			if(clients[a]['stats']['packets_ps']['sum'] > clients[b]['stats']['packets_ps']['sum'])
				return -1;
			return 0;
		});
		//cut off at 10
		order = order.slice(0,10);
		var i = 0;
		for(var o in order) {
			document.getElementById("ip_list_"+(i+1)+"_dest").innerHTML = order[i];
			document.getElementById("ip_list_"+(i+1)+"_ppm").innerHTML = clients[order[i]]['stats']['packets_ps']['sum'];
			document.getElementById("ip_list_"+(i+1)+"_mbps").innerHTML = Math.round(clients[order[i]]['stats']['size_ps']['sum']/(1024*1024)*100)/100;
			i++;
		}
	}
  </script>
</body>
</html>
