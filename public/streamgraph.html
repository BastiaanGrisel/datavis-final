<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <title>Streamgraph</title>
  <style>

    body {
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      margin: auto;
      position: relative;
    }

  </style>

  <script src="http://d3js.org/d3.v3.min.js"></script>
</head>
<body>
  <script>
  // Data processing code
  var queue = [[]], 
      sampleinterval = 100,
      numberofsamples = 20,
      maxval = 1000;

  window.onload = function() {
      var ws = new WebSocket('ws://localhost:8080');

      ws.onmessage = function(event) {
        var msg = JSON.parse(event.data);

        switch(msg.type) {
          case "packet" : window.dispatchEvent(new CustomEvent('packet_received', {"detail": msg.packet})); break;
          case "ip"     : my_ips = msg.ip; break;
        }
      }
    }

  window.addEventListener('packet_received', function (event) {
    var packet = event.detail;
    queue[0].push(packet.link.ip.tcp.data_bytes);
  }, false);

  // Timer that handles the queue
  setInterval(function(){
      queue.unshift([]);

      while(queue.length > numberofsamples)
        queue.pop();
  }, sampleinterval);

  // D3 Visualisation code
  var stack = d3.layout.stack().offset("zero"),
    my_ips = [];

    var width = window.innerWidth,
    height = window.innerHeight;

    var x = d3.scale.linear()
    .domain([0, numberofsamples - 1])
    .range([0, width]);

    var y = d3.scale.linear()
    .domain([0, maxval])
    .range([height, 0]);

    var area = d3.svg.area()
      // .interpolate('basis')
      .x(function(d) { return x(d.x); })
      .y0(function(d) { return y(d.y0); })
      .y1(function(d) { return y(d.y0 + d.y); });

    var svg = d3.select("body").append("svg")
      .attr("width", width)
      .attr("height", height);
    
    // Inital zero line
    svg.selectAll("path")
        .data(stack([d3.range(numberofsamples).map(function(d){ return {"x":d, "y":1}; })]))
        .enter()
        .append("path")
        .attr("d", area)
        .style("fill", "grey");      


    // Timer that does the visualisation
    d3.timer(function() {
      var samples = d3.range(numberofsamples)
        .map(function(index) {
          var y = queue[index] ? queue[index].reduce(function(previousValue, packet_size) { 
              return previousValue += packet_size;//packet.link.ip.tcp.data_bytes; 
            }, 0) : 0;

          return {"x": index, "y": y};
        });

        svg.selectAll("path")
          .data(stack([samples])) // set the new data
          .attr("d", area);
    });

  </script>
</body>
</html>
