<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <title>Streamgraph</title>
  <style>

    body {
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      margin: auto;
      position: relative;
    }

    .line {
      fill: none;
      stroke: steelblue;
      stroke-width: 1.5px;
    }
  </style>

  <script src="http://d3js.org/d3.v3.min.js"></script>
</head>
<body>
  <script>
  // Data processing code
  var queue = [[]], 
      sampleinterval = 100,
      numberofsamples = 20;

  window.onload = function() {
      var ws = new WebSocket('ws://localhost:8080');

      ws.onmessage = function(event) {
        var msg = JSON.parse(event.data);

        switch(msg.type) {
          case "packet" : window.dispatchEvent(new CustomEvent('packet_received', {"detail": msg.packet})); break;
          case "ip"     : my_ips = msg.ip; break;
        }
      }
    }

  window.addEventListener('packet_received', function (event) {
    var packet = event.detail;
    queue[0].push(packet.link.ip.tcp.data_bytes);
  }, false);

  // Timer that handles the queue
  setInterval(function(){
      queue.unshift([]);

      while(queue.length > numberofsamples)
        queue.pop();
  }, sampleinterval);

  // D3 Visualisation code
  var my_ips = [];

    var width = window.innerWidth,
    height = window.innerHeight;

    var x = d3.scale.linear()
    .domain([0, numberofsamples - 1])
    .range([0, width]);

    var y = d3.scale.linear()
    //.domain([0, maxval])
    .range([height, 0]);

    var line = d3.svg.line()
      .interpolate('basis')
      .x(function(d) { return x(d.x); })
      .y(function(d) { return y(d.y); })

    var svg = d3.select("body").append("svg")
      .attr("width", width)
      .attr("height", height);
    
    // Inital zero line
    svg.append("path")
      .data([d3.range(numberofsamples).map(function(d){ return {"x":d, "y":10}; })])
      .attr("class", "line")
      .attr("d", line);

    // Timer that does the visualisation
    maxval = 0;

    d3.timer(function() {

      var samples = d3.range(numberofsamples)
        .map(function(index) {
          var yval = queue[index] ? queue[index].reduce(function(previousValue, packet_size) { 
              return previousValue += packet_size;//packet.link.ip.tcp.data_bytes; 
            }, 0) : 0;

          if(yval > maxval) {
            maxval = yval;
            y.domain([0, maxval]);
          }

          return {"x": index, "y": yval};
        });

        svg.selectAll("path")
          .data([samples]) // set the new data
          .attr("d", line);
    });

  </script>
</body>
</html>
