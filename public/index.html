<html>
<head>
	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
	<script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.7.0/underscore-min.js"></script>	
	<style>
	html, body {
		width: 100%;
		height: 100%;
		margin: 0;
		padding: 0;
	}

	rect {
	  fill: none;
	  pointer-events: all;
	}

	.node {
	  fill: #000;
	}

	.cursor {
	  fill: none;
	  stroke: brown;
	  pointer-events: none;
	}

	.link {
	  stroke: #999;
	}
	</style>
</head>
<body>
	<script>

var width = 960,
    height = 500;

var fill = d3.scale.category20();

var force = d3.layout.force()
    .size([width, height])
    .nodes([{}]) // initialize with a single node
    .linkDistance(30)
    .charge(-60)
    .on("tick", tick);

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

svg.append("rect")
    .attr("width", width)
    .attr("height", height);

var nodes = force.nodes(),
    links = force.links(),
    node = svg.selectAll(".node"),
    link = svg.selectAll(".link");

	node.append("text")
	      .attr("dx", 12)
	      .attr("dy", ".35em")
	      .text(function(d) { return d.name });

var cursor = svg.append("circle")
    .attr("r", 30)
    .attr("transform", "translate(-100,-100)")
    .attr("class", "cursor");

restart();

function tick() {
  link.attr("x1", function(d) { return d.source.x; })
      .attr("y1", function(d) { return d.source.y; })
      .attr("x2", function(d) { return d.target.x; })
      .attr("y2", function(d) { return d.target.y; });

  node.attr("cx", function(d) { return d.x; })
      .attr("cy", function(d) { return d.y; });
}

function restart() {
  link = link.data(links);

  link.enter().insert("line", ".node")
      .attr("class", "link");

  node = node.data(nodes);

  node.enter().insert("circle", ".cursor")
      .attr("class", "node")
      .attr("r", 5)
      .call(force.drag);

  force.start();
}

	window.onload = function() {
		var ws = new WebSocket('ws://localhost:8080');

		ws.onmessage = function (event) {
			var packet = JSON.parse(event.data);
			window.dispatchEvent(new CustomEvent('packet_received', {"detail": packet}));
		}

		window.addEventListener('packet_received', function (event) {
			var packet = event.detail;

			var sourceNodeId = packet.link.ip.saddr;
			var targetNodeId = packet.link.ip.daddr;

			// If source node does not exists, add source node
			sourceNode = _.find(nodes, function(element) {
				return element['id'] == sourceNodeId;
			});

			if(!sourceNode)  {
				sourceNode = {"id": sourceNodeId};
				nodes.push(sourceNode);
			}

			// If target node does not exists, add source node
			targetNode = _.find(nodes, function(element) {
				return element['id'] == targetNodeId;
			});

			if(!targetNode) {
				targetNode = {"id": targetNodeId};
				nodes.push(targetNode);
			} 

			// If a link does not exist, add one
			connection = _.find(links, function(element) {
				return element['source'] == sourceNode &&
					   element['target'] == targetNode;
			});

			if(!connection) 
				connection = links.push({"source": sourceNode, "target": targetNode});

			restart();
		}, false);
	}

	</script>
</body>
</html>